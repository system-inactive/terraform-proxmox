![Status](https://github.com/system-inactive/terraform-proxmox/actions/workflows/terraform.yml/badge.svg)

## Краткое описание

Этот проект **Terraform** был сделан для создания виртуальных машин в тестовом контуре Proxmox с помощью импорта готового образа из хранилища **Proxmox**.

Используется провайдер [telmate/proxmox](https://github.com/Telmate/terraform-provider-proxmox) и так как этот провайдер пока не имеет официальной поддержки `import-from` при создании диска, поэтому временно используется костыль в виде ресурса `null_resource` и `provisioner "local-exec"` в котором при помощи ssh и `pvesh` мы импортируем готовый диск виртуальной машины, подключаем его и устанавливаем нужный размер.  Предполагается, что для непривилегированного ssh пользователя настроен файл sudoers для выполнения команд  `pvesh *` . 

При создании cloudinit образа сразу добавляем в него список необходимых публичных ssh ключей, для создаваемого пользователя.

Виртуальные машины после создания должны быть в состоянии stopped т.к. После создания мы будем импортировать диск из хранилища, менять порядок загрузки и только затем запускать.

В данный момент после изменения переменных force_import, import_from будет создан новый диск из образа без пересоздания виртуальной машины. Так же виртуальная машина не будет пересоздана если диск существует если только не force_import = false и не изменился import_from.
Текущий import_from сохраняется локально в файл  VMID.lastimport.

Необходимые переменные для подключения к кластеру Proxmox

| var                  | value                        | decription                                |
| -------------------- | ---------------------------- | ----------------------------------------- |
| pve_host             | 127.0.0.1                    | имя хоста для подключения                 |
| pve_ssh_user         | terraform                    | имя пользователя ssh для выполнения pvesh |
| pve_api_token        | terraform@pve!terraform      | имя токена proxmox api                    |
| pve_api_token_secret | 000000000-000-0000-000000000 | токен proxmox api                         |
